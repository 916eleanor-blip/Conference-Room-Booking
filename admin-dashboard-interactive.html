<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="WebPartPageExpansion" content="full" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>Conference Room Admin Dashboard</title>
<style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
        color: #1d1d1f;
        min-height: 100vh;
    }

    .header {
        background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);
        color: white;
        padding: 30px 40px;
        box-shadow: 0 4px 12px rgba(0,122,255,0.3);
    }

    .header h1 {
        font-size: 32px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .header p {
        font-size: 17px;
        opacity: 0.9;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }

    .stat-card .label {
        font-size: 14px;
        color: #86868b;
        font-weight: 500;
        margin-bottom: 8px;
    }

    .stat-card .value {
        font-size: 36px;
        font-weight: 700;
        color: #1d1d1f;
        margin-bottom: 4px;
    }

    .stat-card .icon {
        font-size: 48px;
        float: right;
        opacity: 0.2;
    }

    .stat-card.pending { border-left: 4px solid #ff9500; }
    .stat-card.approved { border-left: 4px solid #34c759; }
    .stat-card.rejected { border-left: 4px solid #ff3b30; }
    .stat-card.total { border-left: 4px solid #007aff; }

    .request-list {
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        margin-bottom: 24px;
        overflow: hidden;
    }

    .list-header {
        padding: 24px;
        border-bottom: 1px solid #f5f5f7;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .list-header h2 {
        font-size: 24px;
        font-weight: 600;
    }

    .refresh-btn {
        background: #007aff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .refresh-btn:hover {
        background: #0051d5;
    }

    .request-card {
        border-bottom: 1px solid #f5f5f7;
        padding: 24px;
        transition: background 0.2s;
    }

    .request-card:last-child {
        border-bottom: none;
    }

    .request-card:hover {
        background: #f9f9f9;
    }

    .request-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }

    .request-title {
        font-size: 20px;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 4px;
    }

    .request-meta {
        font-size: 14px;
        color: #86868b;
    }

    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        display: inline-block;
    }

    .status-pending {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .status-approved {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-rejected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .request-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
    }

    .detail-item {
        font-size: 14px;
    }

    .detail-label {
        color: #86868b;
        font-weight: 500;
        margin-bottom: 4px;
    }

    .detail-value {
        color: #1d1d1f;
        font-weight: 600;
    }

    .action-buttons {
        display: flex;
        gap: 12px;
        margin-top: 16px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-approve {
        background: #34c759;
        color: white;
    }

    .btn-approve:hover {
        background: #2da94c;
    }

    .btn-reject {
        background: #ff3b30;
        color: white;
    }

    .btn-reject:hover {
        background: #d32f2f;
    }

    .btn-book {
        background: #007aff;
        color: white;
    }

    .btn-book:hover {
        background: #0051d5;
    }

    .btn:disabled {
        background: #d2d2d7;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .loading {
        text-align: center;
        padding: 60px;
        color: #86868b;
    }

    .loading::after {
        content: "";
        width: 40px;
        height: 40px;
        border: 4px solid #f5f5f7;
        border-top-color: #007aff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 12px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .empty-state {
        text-align: center;
        padding: 60px 24px;
        color: #86868b;
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.3;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 16px;
        padding: 32px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }

    .modal-header {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 16px;
    }

    .modal-body {
        margin-bottom: 24px;
    }

    .modal-body label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
        color: #1d1d1f;
    }

    .modal-body textarea {
        width: 100%;
        padding: 12px;
        border: 1.5px solid #d2d2d7;
        border-radius: 10px;
        font-family: inherit;
        font-size: 15px;
        resize: vertical;
        min-height: 100px;
    }

    .modal-body textarea:focus {
        outline: none;
        border-color: #007aff;
        box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
    }

    .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .btn-cancel {
        background: #f5f5f7;
        color: #1d1d1f;
    }

    .btn-cancel:hover {
        background: #e8e8ed;
    }

    @media (max-width: 768px) {
        .header {
            padding: 20px;
        }
        
        .header h1 {
            font-size: 24px;
        }

        .container {
            padding: 20px 16px;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .request-details {
            grid-template-columns: 1fr;
        }

        .action-buttons {
            flex-direction: column;
        }
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        z-index: 2000;
        display: none;
        align-items: center;
        gap: 12px;
        max-width: 400px;
    }

    .notification.show {
        display: flex;
        animation: slideIn 0.3s ease;
    }

    .notification.success {
        border-left: 4px solid #34c759;
    }

    .notification.error {
        border-left: 4px solid #ff3b30;
    }

    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>
</head>
<body>

<div class="header">
    <h1>Conference Room Admin Dashboard</h1>
    <p>Manage bookings, approvals, and room scheduling ‚Ä¢ <span style="opacity: 0.8;">Local Storage v2.0</span></p>
</div>

<div class="container">
    
    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card pending">
            <div class="icon">‚è≥</div>
            <div class="label">Pending Approvals</div>
            <div class="value" id="pendingCount">0</div>
        </div>
        <div class="stat-card approved">
            <div class="icon">‚úì</div>
            <div class="label">Approved This Month</div>
            <div class="value" id="approvedCount">0</div>
        </div>
        <div class="stat-card rejected">
            <div class="icon">‚úï</div>
            <div class="label">Rejected</div>
            <div class="value" id="rejectedCount">0</div>
        </div>
        <div class="stat-card total">
            <div class="icon">üìä</div>
            <div class="label">Total Requests</div>
            <div class="value" id="totalCount">0</div>
        </div>
    </div>

    <!-- Pending Requests -->
    <div class="request-list">
        <div class="list-header">
            <h2>Pending Approvals</h2>
            <button class="refresh-btn" onclick="loadRequests()">Refresh</button>
        </div>
        <div id="pendingRequests">
            <div class="loading">Loading requests</div>
        </div>
    </div>

</div>

<!-- Approval Modal -->
<div id="approvalModal" class="modal">
    <div class="modal-content">
        <div class="modal-header" id="modalTitle">Approve Request</div>
        <div class="modal-body">
            <label for="approverComments">Comments (optional):</label>
            <textarea id="approverComments" placeholder="Add any notes or instructions..."></textarea>
        </div>
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
            <button class="btn" id="modalConfirmBtn" onclick="confirmAction()">Confirm</button>
        </div>
    </div>
</div>

<!-- Notification -->
<div id="notification" class="notification">
    <span id="notificationText"></span>
</div>

<script>
// ============================================
// LOCAL STORAGE VERSION 2.0 - NO SHAREPOINT
// ============================================
const STORAGE_KEY = "conferenceRoomBookings";
console.log("üöÄ Dashboard Loaded - LOCAL STORAGE MODE v2.0");
console.log("üìä No SharePoint dependencies");

let currentAction = null;
let currentItemId = null;

// Load requests on page load
window.addEventListener('load', () => {
    loadRequests();
});

// Listen for new bookings
window.addEventListener('bookingAdded', () => {
    loadRequests();
});

// Get all bookings from localStorage
function getBookings() {
    const data = localStorage.getItem(STORAGE_KEY);
    return data ? JSON.parse(data) : [];
}

// Save bookings to localStorage
function saveBookings(bookings) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(bookings));
}

// Update booking status
function updateBookingStatus(id, status, comments) {
    const bookings = getBookings();
    const booking = bookings.find(b => b.ID === id);
    if (booking) {
        booking.Approval_x0020_Status = status;
        booking.Approver_x0020_Comments = comments;
        booking.ApprovedDate = new Date().toISOString();
        saveBookings(bookings);
        return true;
    }
    return false;
}

// Load all requests from localStorage
function loadRequests() {
    try {
        // Show loading state
        document.getElementById('pendingRequests').innerHTML = '<div class="loading">Loading requests</div>';
        
        // Small delay to ensure DOM is ready
        setTimeout(() => {
            // Get items from localStorage
            const items = getBookings();
            
            // Update stats
            updateStats(items);
            
            // Filter pending items
            const pendingItems = items.filter(item => item.Approval_x0020_Status === 'Pending');
            
            // Render pending requests
            renderPendingRequests(pendingItems);
        }, 100);
        
    } catch (error) {
        console.error("Error loading requests:", error);
        document.getElementById('pendingRequests').innerHTML = 
            '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Error loading requests. Please refresh the page.</p></div>';
    }
}

// Update statistics
function updateStats(items) {
    const pending = items.filter(i => i.Approval_x0020_Status === 'Pending').length;
    const approved = items.filter(i => i.Approval_x0020_Status === 'Approved').length;
    const rejected = items.filter(i => i.Approval_x0020_Status === 'Rejected').length;
    
    document.getElementById('pendingCount').textContent = pending;
    document.getElementById('approvedCount').textContent = approved;
    document.getElementById('rejectedCount').textContent = rejected;
    document.getElementById('totalCount').textContent = items.length;
}

// Render pending requests
function renderPendingRequests(items) {
    const container = document.getElementById('pendingRequests');
    
    if (items.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úì</div><p>No pending approvals!</p></div>';
        return;
    }
    
    container.innerHTML = items.map(item => `
        <div class="request-card">
            <div class="request-header">
                <div>
                    <div class="request-title">${item.Meeting_x0020_title || 'Untitled Meeting'}</div>
                    <div class="request-meta">
                        Requested by ${item.Name || 'Unknown'} ‚Ä¢ 
                        ${new Date(item.Created).toLocaleDateString()}
                    </div>
                </div>
                <span class="status-badge status-pending">Pending</span>
            </div>
            
            <div class="request-details">
                <div class="detail-item">
                    <div class="detail-label">Room</div>
                    <div class="detail-value">${item.Room || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Site</div>
                    <div class="detail-value">${item.Site || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Start Time</div>
                    <div class="detail-value">${item.Start ? new Date(item.Start).toLocaleString() : 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">End Time</div>
                    <div class="detail-value">${item.End ? new Date(item.End).toLocaleString() : 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Occupancy</div>
                    <div class="detail-value">${item.Occupancy || 'N/A'} people</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Setup</div>
                    <div class="detail-value">${item.Set_x002d_Up || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">IT Assistance</div>
                    <div class="detail-value">${item.IT || 'No'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Meeting Type</div>
                    <div class="detail-value">${item.M_x0020_Type || 'N/A'}</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-approve" onclick="showApprovalModal(${item.ID}, 'approve')">
                    ‚úì Approve
                </button>
                <button class="btn btn-reject" onclick="showApprovalModal(${item.ID}, 'reject')">
                    ‚úï Reject
                </button>
                <button class="btn btn-book" onclick="bookInOutlook(${item.ID}, '${item.Meeting_x0020_title}', '${item.Room}', '${item.Start}', '${item.End}', '${item.Site}')">
                    üìÖ Book in Shared Calendar
                </button>
                <button class="btn btn-book" onclick="copySharedEmail('${item.Site}')" style="background: #5856d6;">
                    üìã Copy Shared Email
                </button>
            </div>
        </div>
    `).join('');
}

// Show approval modal
function showApprovalModal(itemId, action) {
    currentItemId = itemId;
    currentAction = action;
    
    const modal = document.getElementById('approvalModal');
    const title = document.getElementById('modalTitle');
    const btn = document.getElementById('modalConfirmBtn');
    
    if (action === 'approve') {
        title.textContent = 'Approve Request';
        btn.textContent = 'Approve';
        btn.className = 'btn btn-approve';
    } else {
        title.textContent = 'Reject Request';
        btn.textContent = 'Reject';
        btn.className = 'btn btn-reject';
    }
    
    document.getElementById('approverComments').value = '';
    modal.classList.add('show');
}

// Close modal
function closeModal() {
    document.getElementById('approvalModal').classList.remove('show');
    currentItemId = null;
    currentAction = null;
}

// Confirm action
function confirmAction() {
    if (!currentItemId || !currentAction) return;
    
    const comments = document.getElementById('approverComments').value;
    const newStatus = currentAction === 'approve' ? 'Approved' : 'Rejected';
    
    try {
        const success = updateBookingStatus(currentItemId, newStatus, comments);
        
        if (success) {
            showNotification(`Request ${newStatus.toLowerCase()} successfully!`, 'success');
            closeModal();
            
            // Reload requests
            setTimeout(() => loadRequests(), 500);
        } else {
            throw new Error('Booking not found');
        }
        
    } catch (error) {
        console.error("Error updating item:", error);
        showNotification('Error updating request. Please try again.', 'error');
    }
}

// Book in Outlook (opens Outlook with pre-filled event in shared calendar)
function bookInOutlook(itemId, title, room, start, end, site) {
    // Determine calendar email based on site
    const calendarEmail = site === 'HQ CSC FRF' ? 
        'smudconferenceroomscheduler@smud.org' : 
        'eastcampusroomscheduler@smud.org';
    
    // Format dates for Outlook
    const startDate = new Date(start).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    const endDate = new Date(end).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    
    // Create Outlook URL to open shared mailbox calendar with new event
    // This opens the shared calendar view with compose dialog
    const outlookUrl = `https://outlook.office365.com/calendar/0/deeplink/compose?` +
        `path=/calendar/action/compose` +
        `&rru=addevent` +
        `&startdt=${startDate}` +
        `&enddt=${endDate}` +
        `&subject=${encodeURIComponent(title + ' - ' + room)}` +
        `&location=${encodeURIComponent(room)}` +
        `&body=${encodeURIComponent('Conference room booking - Request ID: ' + itemId + '\n\nRoom: ' + room + '\nSite: ' + site)}` +
        `&to=${encodeURIComponent(calendarEmail)}`;
    
    // Alternative: Direct link to shared mailbox calendar
    const sharedCalendarUrl = `https://outlook.office365.com/calendar/view/workweek?exvsurl=1&path=/calendar/action/compose&startdt=${startDate}&enddt=${endDate}&subject=${encodeURIComponent(title)}&location=${encodeURIComponent(room)}&to=${encodeURIComponent(calendarEmail)}`;
    
    // Open in new window
    window.open(outlookUrl, '_blank');
    
    showNotification(`Opening Outlook with ${calendarEmail}...`, 'success');
    
    // Show instructions
    setTimeout(() => {
        showNotification(`Tip: Create event in the shared calendar: ${calendarEmail}`, 'success');
    }, 4000);
}

// Copy shared calendar email to clipboard
function copySharedEmail(site) {
    const calendarEmail = site === 'HQ CSC FRF' ? 
        'smudconferenceroomscheduler@smud.org' : 
        'eastcampusroomscheduler@smud.org';
    
    navigator.clipboard.writeText(calendarEmail).then(() => {
        showNotification(`‚úì Copied: ${calendarEmail}`, 'success');
    }).catch(() => {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = calendarEmail;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showNotification(`‚úì Copied: ${calendarEmail}`, 'success');
    });
}

// Show notification
function showNotification(message, type) {
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notificationText');
    
    notificationText.textContent = message;
    notification.className = 'notification show ' + type;
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 4000);
}

// Auto-refresh every 2 minutes
setInterval(() => {
    loadRequests();
}, 120000);

console.log("Admin Dashboard Loaded - Using Local Storage");
console.log("Current bookings:", getBookings());
</script>

</body>
</html>
